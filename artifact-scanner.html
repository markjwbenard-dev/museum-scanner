<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denman Island Museum Artifact Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            color: #ffffff;
            background: #1a1a1a; /* Fallback background */
        }
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: auto;
        }
        #error-message, #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            max-width: 90%;
            display: none;
        }
        #error-message {
            background: rgba(255, 0, 0, 0.7);
        }
        #loading-message {
            background: rgba(0, 196, 180, 0.7);
        }
        #zoom-control {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 3;
            background: rgba(37, 37, 37, 0.7);
            padding: 5px;
            border-radius: 4px;
        }
        #zoom-control label {
            font-size: 0.8rem;
            color: #cccccc;
            margin-bottom: 5px;
        }
        #zoom-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            height: 200px;
            width: 20px;
            background: #333333;
            border: 1px solid #00c4b4;
            border-radius: 4px;
            cursor: pointer;
        }
        #zoom-slider::-webkit-slider-thumb {
            background: #00c4b4;
            border-radius: 4px;
            width: 20px;
            height: 20px;
        }
        #zoom-slider::-moz-range-thumb {
            background: #00c4b4;
            border-radius: 4px;
            width: 20px;
            height: 20px;
        }
        #header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            text-align: center;
            color: #baa597;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        button {
            background: rgba(212, 160, 23, 0.5);
            color: #1a1a1a;
            padding: 9.6px 19.2px;
            border: 1px solid #d4a017;
            border-radius: 8px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px 5px;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 160, 23, 0.7);
        }
        #explore-further {
            background: rgba(0, 196, 180, 0.5);
            border: 1px solid #00c4b4;
            color: #1a1a1a;
        }
        #explore-further:hover {
            box-shadow: 0 0 15px rgba(0, 196, 180, 0.7);
        }
        #detailed-desc {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #detailed-img {
            max-width: 80%;
            max-height: 50%;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 196, 180, 0.3);
            margin-bottom: 10px;
        }
        #detailed-text {
            font-size: 1rem;
            color: #ffffff;
            margin-bottom: 10px;
            line-height: 1.5;
            padding: 0 20px;
            text-align: center;
        }
        #close-details {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
        }
        #close-details:hover {
            color: #d4a017;
        }
        #chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #chat-container {
            background: #252525;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(212, 160, 23, 0.3);
        }
        #chat-history {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: #333333;
            border-radius: 8px;
        }
        .chat-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .chat-message.user {
            background: rgba(212, 160, 23, 0.5);
            color: #1a1a1a;
            text-align: right;
        }
        .chat-message.bot {
            background: #cccccc;
            color: #1a1a1a;
            text-align: left;
        }
        #chat-input {
            width: calc(100% - 16px);
            padding: 8px;
            border: 1px solid #d4a017;
            border-radius: 8px;
            background: #333333;
            color: #ffffff;
            margin-bottom: 10px;
        }
        #chat-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        #chat-send, #voice-toggle, #chat-close {
            padding: 9.6px 19.2px;
            background: rgba(212, 160, 23, 0.5);
            border: 1px solid #d4a017;
            font-size: 0.88rem;
        }
        #chat-send:hover, #voice-toggle:hover, #chat-close:hover {
            box-shadow: 0 0 15px rgba(212, 160, 23, 0.7);
        }
        @media (max-width: 600px) {
            #header { font-size: 1rem; }
            button { font-size: 0.8rem; padding: 8px 16px; }
            #detailed-text { font-size: 0.9rem; }
            #zoom-slider { height: 150px; }
            #error-message, #loading-message { font-size: 0.9rem; padding: 10px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
    <div id="video-container">
        <video id="video" autoplay playsinline aria-label="Live camera feed for artifact scanning"></video>
        <canvas id="overlay" aria-label="Overlay for real-time artifact detection"></canvas>
        <div id="zoom-control">
            <label for="zoom-slider">Zoom</label>
            <input type="range" id="zoom-slider" min="1" max="4" step="0.1" value="1" aria-label="Zoom control for camera" aria-valuetext="1x zoom">
        </div>
        <div id="error-message" aria-live="assertive"></div>
        <div id="loading-message" aria-live="polite">Loading scanner, please wait...</div>
    </div>
    <h1 id="header" aria-label="Denman Island Museum Artifact Scanner">Denman Island Museum Artifact Scanner</h1>
    <div id="detailed-desc" aria-live="polite">
        <button id="close-details" aria-label="Close detailed description">X</button>
        <img id="detailed-img" alt="Selected artifact">
        <div id="detailed-text"></div>
        <div id="detailed-buttons">
            <button id="explore-further" aria-label="Explore further with AI chat">Explore Further</button>
        </div>
    </div>
    <div id="chat-modal" aria-label="AI chat for artifact exploration">
        <div id="chat-container">
            <div id="chat-history" aria-live="polite"></div>
            <input id="chat-input" type="text" placeholder="Ask about the artifact..." aria-label="Enter your question about the artifact">
            <div id="chat-buttons">
                <button id="chat-send" aria-label="Send chat message">Send</button>
                <button id="voice-toggle" aria-label="Toggle voice input">ðŸŽ¤</button>
                <button id="chat-close" aria-label="Close chat">Close</button>
            </div>
        </div>
    </div>

    <script>
        let videoStream = null;
        let recognition = null;
        let isVoiceActive = false;
        let model;
        let currentPredictions = [];
        let canvas;
        let ctx;

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideLoading();
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 7000);
        }

        function showLoading() {
            document.getElementById('loading-message').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading-message').style.display = 'none';
        }

        async function checkCameraPermissions() {
            try {
                const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                if (permissionStatus.state === 'denied') {
                    showError('Camera access denied. Please enable camera permissions in your browser settings and refresh.');
                    return false;
                }
                return true;
            } catch (err) {
                console.error('Permission check error:', err);
                return true; // Fallback to attempt camera access
            }
        }

        async function setupCamera() {
            const video = document.getElementById('video');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Camera access not supported by this browser. Try Chrome, Firefox, or Edge.');
                return false;
            }

            if (!(await checkCameraPermissions())) return false;

            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.onloadedmetadata = () => {
                    video.play().catch(err => {
                        console.error('Video play error:', err);
                        showError('Failed to start video. Please ensure camera is not in use by another app.');
                    });
                    setupZoom();
                    adjustZoomSliderHeight();
                    window.addEventListener('resize', adjustZoomSliderHeight);
                    canvas = document.getElementById('overlay');
                    ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth || window.innerWidth;
                    canvas.height = video.videoHeight || window.innerHeight;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    hideLoading();
                    detect();
                    setupCanvasClick();
                };
                return true;
            } catch (err) {
                console.error('Camera access error:', err);
                if (err.name === 'NotAllowedError') {
                    showError('Camera access blocked. Please allow camera access in your browser settings.');
                } else if (err.name === 'NotFoundError') {
                    showError('No camera found. Please connect a camera and try again.');
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    showError('Camera is in use by another app or tab. Please close other camera-using apps/tabs and refresh.');
                } else if (err.name === 'OverconstrainedError') {
                    showError('Camera constraints not supported. Trying fallback settings...');
                    return tryFallbackCamera();
                } else {
                    showError(`Camera error: ${err.message}. Please check your device and refresh.`);
                }
                return false;
            }
        }

        async function tryFallbackCamera() {
            const video = document.getElementById('video');
            const constraints = { video: true };
            try {
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.onloadedmetadata = () => {
                    video.play();
                    setupZoom();
                    adjustZoomSliderHeight();
                    canvas = document.getElementById('overlay');
                    ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth || window.innerWidth;
                    canvas.height = video.videoHeight || window.innerHeight;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    hideLoading();
                    detect();
                    setupCanvasClick();
                };
                return true;
            } catch (err) {
                console.error('Fallback camera error:', err);
                showError('Fallback camera failed. Please ensure a camera is available and not in use.');
                return false;
            }
        }

        function releaseCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                console.log('Camera stream released');
            }
        }

        window.addEventListener('unload', releaseCamera);

        function adjustZoomSliderHeight() {
            const videoHeight = window.innerHeight;
            const sliderHeight = videoHeight * 0.3 - 30;
            document.getElementById('zoom-slider').style.height = `${sliderHeight}px`;
        }

        function setupZoom() {
            const zoomSlider = document.getElementById('zoom-slider');
            zoomSlider.addEventListener('input', async () => {
                const zoomValue = parseFloat(zoomSlider.value);
                zoomSlider.setAttribute('aria-valuetext', `${zoomValue}x zoom`);
                if (videoStream) {
                    const track = videoStream.getVideoTracks()[0];
                    try {
                        await track.applyConstraints({ advanced: [{ zoom: zoomValue }] });
                    } catch (err) {
                        console.error('Zoom error:', err);
                        showError('Zoom not supported on this device.');
                    }
                }
            });
        }

        async function loadModel() {
            try {
                model = await cocoSsd.load();
                console.log('Coco-SSD model loaded successfully');
                hideLoading();
            } catch (err) {
                console.error('Model load error:', err);
                showError('Failed to load detection model. Please check your internet and refresh.');
            }
        }

        function detect() {
            if (!model || !ctx) {
                showError('Model or canvas not ready. Please refresh.');
                return;
            }
            model.detect(document.getElementById('video')).then(preds => {
                currentPredictions = preds.filter(p => p.score > 0.5);
                drawHighlights();
                requestAnimationFrame(detect);
            }).catch(err => {
                console.error('Detection error:', err);
                showError('Object detection failed. Please try again.');
            });
        }

        function drawHighlights() {
            const video = document.getElementById('video');
            canvas.width = video.videoWidth || window.innerWidth;
            canvas.height = video.videoHeight || window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentPredictions.forEach(pred => {
                const [x, y, width, height] = pred.bbox;
                ctx.strokeStyle = '#00c4b4';
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, width, height);
                ctx.fillStyle = '#00c4b4';
                ctx.font = '16px Inter';
                ctx.fillText(pred.class, x, y > 10 ? y - 5 : y + 15);
            });
        }

        function setupCanvasClick() {
            canvas = document.getElementById('overlay');
            canvas.addEventListener('click', e => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clickX = (e.clientX - rect.left) * scaleX;
                const clickY = (e.clientY - rect.top) * scaleY;
                for (let pred of currentPredictions) {
                    const [x, y, w, h] = pred.bbox;
                    if (clickX > x && clickX < x + w && clickY > y && clickY < y + h) {
                        displayDetails(pred);
                        break;
                    }
                }
            });
        }

        function displayDetails(pred) {
            const video = document.getElementById('video');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            const [x, y, width, height] = pred.bbox;
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.drawImage(video, x, y, width, height, 0, 0, width, height);
            const thumbnailDataUrl = tempCanvas.toDataURL('image/jpeg');

            const artifactInfo = {
                'vase': {
                    brief: 'Ancient Vase',
                    full: 'This ancient vase from 500 BC holds secrets of island pottery. Crafted by skilled artisans, it showcases intricate patterns unique to Denmanâ€™s coastal heritage.'
                },
                'cup': {
                    brief: 'Enchanted Teapot',
                    full: 'Behold the enchanted teapot! This 19th-century relic was found on a shipwreck near Denman Island, symbolizing the islandâ€™s maritime history.'
                },
                'default': {
                    brief: pred.class,
                    full: `Detected ${pred.class} with ${Math.round(pred.score * 100)}% confidence. Explore its mysteries with the AI chat!`
                }
            };
            const info = artifactInfo[pred.class] || artifactInfo['default'];

            const currentItem = {
                thumbnail: thumbnailDataUrl,
                brief: info.brief,
                full: info.full
            };

            const detailedDesc = document.getElementById('detailed-desc');
            const detailedImg = document.getElementById('detailed-img');
            const detailedText = document.getElementById('detailed-text');
            const exploreFurther = document.getElementById('explore-further');
            const closeDetails = document.getElementById('close-details');

            detailedImg.src = thumbnailDataUrl;
            detailedText.innerHTML = info.full;
            exploreFurther.onclick = () => openChatModal(currentItem);
            closeDetails.onclick = () => {
                detailedDesc.style.display = 'none';
            };

            detailedDesc.style.display = 'flex';
        }

        function openChatModal(item) {
            const chatModal = document.getElementById('chat-modal');
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = `<div class="chat-message bot">Ask me anything about the ${item.brief}!</div>`;
            chatModal.style.display = 'flex';

            const chatSend = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');
            const voiceToggle = document.getElementById('voice-toggle');
            const chatClose = document.getElementById('chat-close');

            async function getLLMResponse(userInput, context) {
                try {
                    const response = await fetch('https://museum-scanner-v2.vercel.app/api/xai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'grok-4',
                            messages: [
                                {
                                    role: 'system',
                                    content: `You are a history expert at Denman Island Museum, BC, Canada. Provide detailed, engaging answers about the artifact: ${context.brief}. Description: ${context.full}.`
                                },
                                { role: 'user', content: userInput }
                            ],
                            max_tokens: 500,
                            temperature: 0.7
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (err) {
                    console.error('xAI API error:', err);
                    return `Oops! Chat error: ${err.message}. Try again or check the server.`;
                }
            }

            chatSend.onclick = async () => {
                const userInput = chatInput.value.trim();
                if (userInput) {
                    chatHistory.innerHTML += `<div class="chat-message user">${userInput}</div>`;
                    const botMessage = document.createElement('div');
                    botMessage.className = 'chat-message bot';
                    botMessage.textContent = 'Thinking...';
                    chatHistory.appendChild(botMessage);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    const response = await getLLMResponse(userInput, item);
                    botMessage.textContent = response;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    chatInput.value = '';
                    if (isVoiceActive) speak(response);
                }
            };

            voiceToggle.onclick = () => {
                if (!isVoiceActive) {
                    try {
                        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                        recognition.lang = 'en-US';
                        recognition.onresult = (event) => {
                            chatInput.value = event.results[0][0].transcript;
                            chatSend.click();
                        };
                        recognition.onerror = (err) => {
                            console.error('Speech recognition error:', err);
                            showError('Voice input failed. Try typing instead.');
                        };
                        recognition.start();
                        voiceToggle.textContent = 'ðŸŽ™ï¸';
                        voiceToggle.setAttribute('aria-label', 'Stop voice input');
                        isVoiceActive = true;
                    } catch (err) {
                        showError('Voice input not supported on this device.');
                    }
                } else {
                    recognition.stop();
                    voiceToggle.textContent = 'ðŸŽ¤';
                    voiceToggle.setAttribute('aria-label', 'Toggle voice input');
                    isVoiceActive = false;
                }
            };

            function speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            }

            chatClose.onclick = () => {
                chatModal.style.display = 'none';
                if (isVoiceActive) {
                    recognition.stop();
                    voiceToggle.textContent = 'ðŸŽ¤';
                    voiceToggle.setAttribute('aria-label', 'Toggle voice input');
                    isVoiceActive = false;
                }
            };
        }

        async function init() {
            showLoading();
            const cameraSuccess = await setupCamera();
            if (cameraSuccess) {
                await loadModel();
            } else {
                hideLoading();
            }
        }
        init();
    </script>
</body>
</html>
